# ------------------------------------------------------------
# Release Workflow
# ------------------------------------------------------------
# Purpose:
# This workflow publishes a Docker image to Docker Hub.
#
# It is intentionally triggered ONLY when a semantic version
# tag is pushed (for example: v1.0.0).
#
# Why tags only?
# - Keeps releases explicit and intentional
# - Avoids publishing images on every merge
# - Makes deployments deterministic (deploy vX.Y.Z)
# - Matches course expectations for Docker Hub publishing
# ------------------------------------------------------------

name: Release

on:
  # Trigger only when pushing a version tag like v1.0.0
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read

concurrency:
  # Prevents multiple release runs for the same tag.
  # If someone re-pushes or retriggers quickly,
  # GitHub cancels the older run.
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish_version:
    name: Publish Docker image (version tag)
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # Checkout the exact commit that the tag points to.
      # This guarantees that the Docker image is built from
      # the tagged source code, not from some other branch.
      # --------------------------------------------------------
      - name: Checkout tagged commit
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Authenticate to Docker Hub using repository secrets.
      #
      # Required GitHub secrets:
      # - DOCKERHUB_USERNAME
      # - DOCKERHUB_TOKEN (Personal Access Token with write access)
      #
      # These secrets must be configured in:
      # GitHub → Settings → Secrets and variables → Actions
      # --------------------------------------------------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --------------------------------------------------------
      # Build and push the Docker image.
      #
      # We publish two tags:
      #
      # 1) vX.Y.Z
      #    → Immutable, deterministic release tag.
      #      This is what should be used in deployments.
      #
      # 2) latest
      #    → Convenience tag pointing to the most recent
      #      released version.
      #
      # This ensures:
      # - Stable versioned deployments
      # - Easy local testing via :latest
      # --------------------------------------------------------
      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/events-api:${{ github.ref_name }}