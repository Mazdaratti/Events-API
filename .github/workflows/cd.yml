# ------------------------------------------------------------
# Continuous Deployment Workflow
# ------------------------------------------------------------
# Purpose:
# This workflow performs Continuous Deployment for the Events API.
#
# It is responsible for:
# 1. Building and publishing the Docker image tagged as `latest`
#    to Docker Hub.
# 2. Triggering a redeploy of the Render web service.
# 3. Verifying the live deployment using smoke tests.
#
# Why only main?
# - main represents the deployable state of the application.
# - Every merge to main must be production-ready.
# - Feature branches are validated in CI but never deployed.
#
# Why `latest`?
# - `latest` acts as the deployment channel consumed by Render.
# - Versioned releases (vX.Y.Z) are handled separately
#   by the Release workflow.
#
# Separation of responsibilities:
# - CI workflow      → builds & tests (unit + container + integration)
# - CD workflow      → publishes `latest`, deploys, verifies runtime
# - Release workflow → publishes immutable version tags (vX.Y.Z)
#
# Required repository secrets:
# - DOCKERHUB_USERNAME
# - DOCKERHUB_TOKEN
# - RENDER_DEPLOY_HOOK
# - RENDER_BASE_URL  (e.g. https://events-api-latest.onrender.com)
# ------------------------------------------------------------

name: CD

on:
  # Continuous deployment is triggered only when main is updated.
  push:
    branches:
      - main
    # Ignore documentation-only changes to avoid unnecessary deploys.
    paths-ignore:
      - "README.md"
      - "**/*.md"

permissions:
  contents: read

concurrency:
  # Prevent multiple CD runs for the same branch ref.
  # If a new commit is pushed while a deployment is running,
  # the previous run is cancelled.
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy_render:
    name: Build, Deploy and Verify (Render)
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # Checkout the exact commit that was merged into main.
      # Ensures the Docker image is built from the deployed code.
      # --------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Authenticate to Docker Hub using repository secrets.
      # Required:
      # - DOCKERHUB_USERNAME
      # - DOCKERHUB_TOKEN
      # --------------------------------------------------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --------------------------------------------------------
      # Build and push the Docker image tagged as `latest`.
      #
      # `latest` is the active deployment channel used by Render.
      # Each push to main updates this tag.
      # --------------------------------------------------------
      - name: Build and push image (latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/events-api:latest

      # --------------------------------------------------------
      # Trigger Render to redeploy the service.
      #
      # The deploy hook tells Render to pull the updated
      # `latest` image from Docker Hub.
      #
      # Required secret:
      # - RENDER_DEPLOY_HOOK
      # --------------------------------------------------------
      - name: Trigger Render deploy
        run: |
          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"

      # --------------------------------------------------------
      # Smoke Test – Runtime Verification
      #
      # Validates that:
      # 1. The service is reachable (/api/health).
      # 2. A real API route responds successfully (/api/events).
      #
      # This confirms:
      # - Container started correctly
      # - Routing works
      # - Database read path works
      #
      # Required secret:
      # - RENDER_BASE_URL
      # --------------------------------------------------------
      - name: Smoke test (Render deployment)
        env:
          BASE_URL: ${{ secrets.RENDER_BASE_URL }}
        run: |
          set -e

          health_url="${BASE_URL%/}/api/health"
          events_url="${BASE_URL%/}/api/events"

          for i in {1..30}; do
            if curl -fsS "$health_url" > /dev/null && \
               curl -fsS "$events_url" > /dev/null; then
              echo "✅ Smoke test passed"
              exit 0
            fi
            echo "Waiting for Render deploy... ($i/30)"
            sleep 5
          done

          echo "❌ Smoke test failed"
          exit 1